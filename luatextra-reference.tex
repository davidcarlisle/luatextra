% Copyright (C) 2009 by Elie Roux <elie.roux@telecom-bretagne.eu>
%
% This work is under the CC0 license. Basically this means that you can do
% (almost) whatever you want with it without asking for permission.

\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage{lmodern}

\usepackage{metalogo}
\usepackage{graphicx}
\usepackage[bookmarks=true, colorlinks=true]{hyperref}
\usepackage{bookmark}
\usepackage[english]{babel}

\hypersetup{
  pdftitle={LuaTeXtra references},
  pdfauthor={Elie Roux},
  pdfsubject={LuaTeXtra references},
}

\providecommand\eTeX{e\TeX}
\newcommand\pf{\textsf}
\newcommand\file{\texorpdfstring{\nolinkurl}{}}
\newcommand\code{\texttt}

\title{Lua\TeX tra reference}
\author{Elie Roux \\ \url{elie.roux@telecom-bretagne.eu}}

\begin{document}

\maketitle

\subsubsection*{Preamble: What is this document?}

This document describes, from the user or developer point of view, how to use
the coherent set of packages \pf{luatextra}, \pf{luatexbase},
\pf{luainputenc}, and \pf{lualibs} (previously \pf{luaextra}).

If you are looking for documentation on the \LuaTeX\ engine, please refer to
the file \file{luatexref-t.pdf}, but note that using these packages will
slightly modify some \LuaTeX\ behaviours, especially the \code{callback}
library.

If you are looking for technical details about one of the packages, you can
refer to its documentation. Each of them have a complete documentation in the
file \file{package.pdf} with package being the name of the package.

\tableofcontents

\section{Introduction}

Before going any further, we need to explain the difference between an engine,
a format, and a program. If you know the difference between these, please go
to section \ref{sub:luatextra}.

\subsection{What is \LuaTeX ?}

\LuaTeX\ is a \TeX\ engine. A \TeX\ engine is a binary executable that
provides some very low-level primitives, for example \verb+\count+ to
set a counter to a certain value. Examples of engines are the old \TeX\ 82,
\eTeX, pdf\TeX, Omega, Aleph, Lua\TeX\ and \XeTeX .

There are two main differences between \LuaTeX\ and its predecessor, pdfTeX:
\LuaTeX\ now truely understands UTF-8 and enables the execution of some lua
code at certain points of the \TeX\ algorithm. These two features allow, among
other things, to open modern fonts like OpenType or TrueType fonts.

\subsection{What is the difference with \LaTeX ?}

The nature of \LaTeX\ is fundamentally different: \LaTeX\ is a \TeX\ format.
Examples of formats are Plain, \LaTeX\ and Con\TeX t.

This distinction is very hard to make, first because you cannot find any
documentation on it, and secondly because the only things everyone knows are
programs. A program is a command you type in your terminal that calls an
engine with a format. Here are the different things behind what you type:

\begin{itemize}
  \item \code{tex} is the engine \TeX\ 82 with the format Plain. Both were
    created by Donald Knuth a very long time ago.
  \item \code{pdftex} is the engine pdf\TeX\ (in PDF mode) with the format
    Plain.
  \item \code{luatex} is the engine \LuaTeX\ (in PDF mode) with the format
    Plain.
  \item \code{xetex} is the engine \XeTeX\ (in PDF mode) with the format
    Plain.
  \item \code{latex} is the engine pdf\TeX\ (in DVI mode) with the format
    \LaTeX .
  \item \code{pdflatex} is the engine pdf\TeX\ (in PDF mode) with the format
    \LaTeX .
  \item \code{lualatex} is the engine \LuaTeX\ (in PDF mode) with the format
    \LaTeX .
  \item \code{xelatex} is the engine \XeTeX\ (in PDF mode) with the format
    \LaTeX .
\end{itemize}

pdf\TeX\ and \LuaTeX\ can produce both DVI and PDF output. To choose it, you
can simply set \verb+\pdfoutput+ to 0 or 1.

As you can see, there is absolutely no corellation between \LuaTeX\ and
\LaTeX, even if the names are close\dots

\subsection{What is Lua\TeX tra?\label{sub:luatextra}}

Lua\TeX tra is the adaptation of the engine \LuaTeX\ to the formats Plain and
\LaTeX . It enables these formats to benefit from the \LuaTeX\ new features,
like UTF-8 reading, attributes handling, extended registers, modern font
opening, etc.

\LuaTeX\ provides only very low-level macros for these features, and a lot of
code has to be done by the format to really provide a good user experience.

With what I just said, a good question would be the following: why isn't
\pf{luatextra} integrated into \LaTeX\ and Plain?

The answer is simple: because Plain and \LaTeX\ are frozen. This means that
they don't accept new code anymore, even if it's totally necessary to benefit
from new engines. Thus, the only solution is to provide a package that every
user will have to load.

\subsection{Why is it necessary?}

\LuaTeX tra is necessary for users and developers because it provides a way
for several packages to access ressources.

Let's take a very concrete example: \LuaTeX\ has a totally new concept named
attributes; basically they can be considered as special counts: you can name
them with the primitive \verb+\attribute+, like you can name an
counter with \verb+\count+, and you can give them a value with
\verb+\attributedef+, that works like \verb+\countdef+ (see
the \LuaTeX\ documentation for more details about attributes). Attributes,
like counts, are described by numbers, for example you have
\verb+\attribute0+, \verb+\attribute1+, etc.

Plain and \LaTeX\ provide a macro \verb+\newcount+ that takes the first free
counter and attributes it a name, for example we can image that
\verb+\newcount\foo+ will in fact do \verb+\count25\foo+. This enables
packages to automatically take a free counter. Without it, package developers
would have to maintain a list saying ``please don't take attribute number foo,
it's for the package bar!".

Plain and \LaTeX\ do not provide \verb+\newattribute+ to allocate a
free attribute; but we do it in \pf{luatexbase}. Without \LuaTeX tra,
people have to take arbitrary attributes and cross their fingers hoping that
noone else will use the attributes they've chosen. With \LuaTeX tra, you can
safely take attributes, being sure that noone else will use them.

Another similar problem is callback access: by default \LuaTeX\ does not
provide a way to register several functions in a callback, so if two packages
want to register a function in a callback, they won't be compatible, as only
one will work. \pf{luamcallback} provides a new mechanism for callbacks
that enables this, allowing more package compatibility.

These two problems are very concrete, that's the main reason why \LuaTeX tra
has been created: without it a lot of package compatibility problems would
have been raised.

\subsection{The different packages}

The \LuaTeX tra coherent set of packages contains:

\begin{itemize}
  \item \pf{luatextra}: a wrapper loading other packages and providing
    additional goodies;
  \item \pf{luatexbase}: low-level functions for resources handling and
    compatibility. Divided in sub-packages, like \pf{luatexbase-mcb} (formerly
    \pf{luamcallbacks} that allows to register several functions in a
    callback;
  \item \pf{luainputenc}: adaptation of \pf{inputenc} to \LuaTeX;
  \item \pf{lualibs}: additional lua functions (previously \pf{luaextra}).
\end{itemize}

\subsection{Overview}

The main idea, as explained above, is to provide a safe way to use different
packages that are not coherent, without loading several times the same code,
or taking ressources (like attributes) already used by other packages.

To do so, we have used a concept for lua files named ``module", inspired by
the \LaTeX\ packages. \textbf{Warning:} the module concept described here
comes as an extention to the base lua module concept. We advise not to use the
base lua modules, but the \LuaTeX tra module system, as it provides more
informations, prints informations in logs, etc. The \LuaTeX tra lua module
system works basically like the \LaTeX\ package system: you can simply use
them, or require them with a version number, etc.

As explained above, another important function provided by \LuaTeX tra is
attributes allocation with \verb+\newluaattribute+.

\subsection{Naming conventions}

In \LuaTeX tra we decided to adopt a simple naming convention: all macros
start by \code{lua}. There are though a few exceptions: for instance we
renamed the concept of \LuaTeX 's \code{attribute} to \code{luaattribute},
as attribute is already something used by a lot of packages and users. This
lead us to name our macros \verb+\newluaattribute+,
\verb+\unsetluaattribute+, etc. for backward compatibility. On the
same principle, \code{catcodetable} is replaced by \code{luacatcodetable}.

\section{Basic user point of view}

\subsection{Plain and \LaTeX\ macros}

The most useful macro provided by \pf{luatextra} is certainly
\verb+\luadirect+, which is a wrapper for \verb+\directlua+,
but will keep the same signature whatever the \LuaTeX\ version. For example
this macro works for \LuaTeX\ versions $<$ 0.36, and will most certainly work
for future versions of \LuaTeX . It is advised to use this macro to keep the
compatibility of your package with all versions of \LuaTeX .
\verb+\lualate+ is also provided as a wrapper for
\verb+\latelua+.

Under \LaTeX, the \pf{metalogo} package is loaded, providing the macros
\verb+\LuaTeX+ and \verb+\LuaLaTeX+ to typeset the logos.

\pf{luatextra} automatically loads \pf{luaotfload}, so you can open otf fonts
directly, for instance \verb+\font\foo="LinLibertine.otf"\foo+ will work. You
can also pass options to the font opening, for example the different OTF
options you want. These options are passed with the \XeTeX\ font syntax
(briefly described in \file{XeTeX-reference.pdf}), for example if you want to
open a font with the usual \TeX\ substitutions and ligatures, with also the
font default ligatures, you can try \newline
\verb!\font\foo="LinLibertine.otf;+tlig;+tsub;+liga;+rlig;"\foo!.

\subsection{\LaTeX -only macros}

\LuaTeX tra also provides an environment for lua code integration:
\code{luacode}. You can simply use it this way:

\begin{verbatim}
\begin{luacode}
texio.write_nl("It works!")
\end{luacode}
\end{verbatim}

\section{Advanced user point of view}

\subsection{lua modules}

See \file{luatexbase-modutils.pdf}.

\subsection{attributes}

We already talked about the most important function:
\verb+\newluaattribute+. It is the equivalent of
\verb+\newcount+ for attributes.

Another important function is \verb+\unsetluaattribute+ that unsets
an attribute. It's adised to use this macro instead of unsetting it by hand,
as the unset value may change (it changed in version 0.37 from \code{-1} to
\code{-"7FFFFFFF}).

You can also use the macro \verb+\setluaattribute+ that takes an
attribute and a value as arguments, and set the argument to the asked value.

\subsection{catcodetables}

The equivalent of \verb+\newcount+ for catcodetables is
\verb+\newluacatcodetable+. Also a set of predefined catcodetables
comes with \LuaTeX tra:

\begin{itemize}
  \item \verb+\CatcodeTableIniTeX+: the base \TeX\ catcodes
  \item \verb+\CatcodeTableString+: almost all characters have
    catcode 12
  \item \verb+\CatcodeTableOther+: all characters have catcode 12
    (even space)
  \item \verb+\CatcodeTableLaTeX+: the \LaTeX\ classical catcodes
\end{itemize}

\subsection{callbacks}

For more informations about this part, see the documentation
\code{luatexbase-mcb.pdf}.

One of the main goals of \LuaTeX tra is also to provide a way for several
packages to register their functions in one callback. The function
\code{callback.register} does not provide any way to do so. To fix it,
\LuaTeX tra provides the function \code{callback.add} that takes the same
two first arguments as \code{callback.register} (name of the callback and
function to register), and two other arguments: a mandatory description of the
function, and an optional priority (the lower the number, the higher the
priority).

If people use \code{callback.register} all the \LuaTeX tra mechanism is
broken, so we override \code{callback.register} with a function that simply
outputs an error message.

Three other very useful new functions are provided:

\begin{itemize}
  \item \code{callback.remove} takes the name of a callback and the
    description of a register function (third argument of
    \code{callback.add}), and removes the function from a callback.
  \item \code{callback.reset} removes all register functions from a
    callback.
  \item \code{callback.get\_priority} takes the name of a callback and the
    description of a registered function, and returns the priority of the
    function in the callback, or 0 if the function is not registered.
\end{itemize}

\subsection{lua extra functions}

Some extra functions have been added to the standard lua library, mostly
coming from the Con\TeX t libraries, for the complete list of functions,
please refer to the documentation \code{lualibs.pdf}.

The most useful of these added functions is certainly \code{table.serialize}
that returns the string describing a given table. This string can be used for
debugging purposes, or table saving in files, as the string can be read by lua
to rebuild the original table.

\end{document}
